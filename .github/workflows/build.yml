# .github/workflows/build.yml
name: Build Windows

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install build tools
        shell: powershell
        run: |
          choco install cygwin -y --params '/InstallDir:C:\cygwin64'
          choco install mingw -y
          choco install make -y
          choco install 7zip -y
          choco install wget -y
          choco install unzip -y
          choco install dos2unix -y

      - name: Setup PATH
        shell: powershell
        run: |
          $cygwinPath = "C:\cygwin64\bin"
          $mingwPath = "C:\ProgramData\chocolatey\lib\mingw\tools\install\mingw64\bin"
          echo "$cygwinPath;$mingwPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Fix download_and_extract_windows_deps.sh line endings
        shell: bash
        run: dos2unix download_and_extract_windows_deps.sh 2>&1 || sed -i 's/\r$//' download_and_extract_windows_deps.sh; chmod +x download_and_extract_windows_deps.sh

      - name: Download FFmpeg
        shell: powershell
        run: |
          C:\cygwin64\bin\bash.exe --noprofile --norc -eo pipefail -c "./download_and_extract_windows_deps.sh ffmpeg"

      - name: Download SDL2
        shell: powershell
        run: |
          C:\cygwin64\bin\bash.exe --noprofile --norc -eo pipefail -c "./download_and_extract_windows_deps.sh sdl2 release-2.32.8"

      - name: Download SDL2_ttf
        shell: powershell
        run: |
          C:\cygwin64\bin\bash.exe --noprofile --norc -eo pipefail -c "./download_and_extract_windows_deps.sh sdl2_ttf release-2.24.0"

      - name: Build
        shell: powershell
        run: |
          C:\cygwin64\bin\bash.exe --noprofile --norc -eo pipefail -c "make"

      - name: Copy runtime DLLs from MinGW
        shell: powershell
        run: |
          $dllDir = "C:\mingw64\bin"
          $dlls = @(
            'libgcc_s_seh-1.dll',
            'libstdc++-6.dll',
            'libwinpthread-1.dll'
          )

          foreach ($dll in $dlls) {
            $srcPath = Join-Path $dllDir $dll
            if (Test-Path $srcPath) {
              Copy-Item $srcPath -Destination '.' -Force
              Write-Host "Copied $dll from $srcPath"
            } else {
              Write-Error "Required DLL '$dll' not found at $srcPath"
              exit 1
            }
          }

      - name: Verify build output
        shell: powershell
        run: |
          if (Test-Path "video-compare.exe") {
            $file = Get-Item "video-compare.exe"
            Write-Host "Build successful!"
            Write-Host "File: $($file.Name)"
            Write-Host "Size: $([math]::Round($file.Length / 1MB, 2)) MB"
            Write-Host "Date: $($file.LastWriteTime)"
          } else {
            Write-Error "Build failed: video-compare.exe not found"
            exit 1
          }

      - name: Strip executable
        shell: powershell
        run: |
          $stripPath = "C:\mingw64\bin\strip.exe"
          if (Test-Path $stripPath) {
            Write-Host "Stripping executable using $stripPath"
            & $stripPath video-compare.exe
            $file = Get-Item "video-compare.exe"
            Write-Host "Stripped executable. New size: $([math]::Round($file.Length / 1MB, 2)) MB"
          } else {
            Write-Error "strip tool not found at $stripPath"
            exit 1
          }

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: video-compare-windows
          path: |
            video-compare.exe
            *.dll
            README.md
          retention-days: 90
