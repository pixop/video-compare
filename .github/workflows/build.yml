# .github/workflows/build.yml
name: Build

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install build tools
        shell: powershell
        run: |
          choco install cygwin -y --params '/InstallDir:C:\cygwin64'
          choco install mingw -y
          choco install make -y
          choco install 7zip -y
          choco install wget -y
          choco install unzip -y

      - name: Setup PATH
        shell: powershell
        run: |
          $cygwinPath = "C:\cygwin64\bin"
          $mingwPath = "C:\ProgramData\chocolatey\lib\mingw\tools\install\mingw64\bin"
          echo "$cygwinPath;$mingwPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Download FFmpeg
        shell: powershell
        run: |
          C:\cygwin64\bin\bash.exe --noprofile --norc -eo pipefail -c "./download_and_extract_windows_deps.sh ffmpeg"

      - name: Download SDL2
        shell: powershell
        run: |
          C:\cygwin64\bin\bash.exe --noprofile --norc -eo pipefail -c "./download_and_extract_windows_deps.sh sdl2 release-2.32.8"

      - name: Download SDL2_ttf
        shell: powershell
        run: |
          C:\cygwin64\bin\bash.exe --noprofile --norc -eo pipefail -c "./download_and_extract_windows_deps.sh sdl2_ttf release-2.24.0"

      - name: Build
        shell: powershell
        run: |
          C:\cygwin64\bin\bash.exe --noprofile --norc -eo pipefail -c "make"

      - name: Copy runtime DLLs from MinGW
        shell: powershell
        run: |
          $dllDir = "C:\mingw64\bin"
          $dlls = @(
            'libgcc_s_seh-1.dll',
            'libstdc++-6.dll',
            'libwinpthread-1.dll'
          )

          foreach ($dll in $dlls) {
            $srcPath = Join-Path $dllDir $dll
            if (Test-Path $srcPath) {
              Copy-Item $srcPath -Destination '.' -Force
              Write-Host "Copied $dll from $srcPath"
            } else {
              Write-Error "Required DLL '$dll' not found at $srcPath"
              exit 1
            }
          }

      - name: Verify build output
        shell: powershell
        run: |
          if (Test-Path "video-compare.exe") {
            $file = Get-Item "video-compare.exe"
            Write-Host "Build successful!"
            Write-Host "File: $($file.Name)"
            Write-Host "Size: $([math]::Round($file.Length / 1MB, 2)) MB"
            Write-Host "Date: $($file.LastWriteTime)"
          } else {
            Write-Error "Build failed: video-compare.exe not found"
            exit 1
          }

      - name: Strip executable
        shell: powershell
        run: |
          $stripPath = "C:\mingw64\bin\strip.exe"
          if (Test-Path $stripPath) {
            Write-Host "Stripping executable using $stripPath"
            & $stripPath video-compare.exe
            $file = Get-Item "video-compare.exe"
            Write-Host "Stripped executable. New size: $([math]::Round($file.Length / 1MB, 2)) MB"
          } else {
            Write-Error "strip tool not found at $stripPath"
            exit 1
          }

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: video-compare-windows
          path: |
            video-compare.exe
            *.dll
            README.md
          retention-days: 90

  build-linux:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libavformat-dev \
            libavcodec-dev \
            libavfilter-dev \
            libavutil-dev \
            libswscale-dev \
            libswresample-dev \
            libsdl2-dev \
            libsdl2-ttf-dev

      - name: Build
        run: make

      - name: Verify build output
        run: |
          if [ -f "video-compare" ]; then
            echo "Build successful!"
            ls -lh video-compare
            file video-compare
          else
            echo "Build failed: video-compare not found"
            exit 1
          fi

      - name: Strip executable
        run: |
          strip video-compare
          echo "Stripped executable. New size:"
          ls -lh video-compare

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: video-compare-linux
          path: |
            video-compare
            README.md
          retention-days: 90

  build-macos:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies via Homebrew
        run: |
          brew install ffmpeg sdl2 sdl2_ttf

      - name: Build
        run: make

      - name: Verify build output
        run: |
          if [ -f "video-compare" ]; then
            echo "Build successful!"
            ls -lh video-compare
            file video-compare
          else
            echo "Build failed: video-compare not found"
            exit 1
          fi

      - name: Strip executable
        run: |
          strip video-compare
          echo "Stripped executable. New size:"
          ls -lh video-compare

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: video-compare-macos
          path: |
            video-compare
            README.md
          retention-days: 90
