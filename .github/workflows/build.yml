# .github/workflows/build.yml
on:
  push:
    tags:
      - "20[0-9][0-9][0-1][0-9][0-3][0-9]"
      - "20[0-9][0-9][0-1][0-9][0-3][0-9].*"
    branches:
      - "**"
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-windows:
    runs-on: windows-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install build tools
        shell: powershell
        run: |
          choco install cygwin -y --params '/InstallDir:C:\cygwin64'
          choco install mingw -y
          choco install make -y
          choco install 7zip -y
          choco install wget -y
          choco install unzip -y

      - name: Setup PATH
        shell: powershell
        run: |
          $cygwinPath = "C:\cygwin64\bin"
          $mingwPath = "C:\ProgramData\chocolatey\lib\mingw\tools\install\mingw64\bin"
          echo "$cygwinPath;$mingwPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Download FFmpeg
        shell: powershell
        run: |
          C:\cygwin64\bin\bash.exe --noprofile --norc -eo pipefail -c "./download_and_extract_windows_deps.sh ffmpeg"

      - name: Download SDL2
        shell: powershell
        run: |
          C:\cygwin64\bin\bash.exe --noprofile --norc -eo pipefail -c "./download_and_extract_windows_deps.sh sdl2 release-2.32.8"

      - name: Download SDL2_ttf
        shell: powershell
        run: |
          C:\cygwin64\bin\bash.exe --noprofile --norc -eo pipefail -c "./download_and_extract_windows_deps.sh sdl2_ttf release-2.24.0"

      - name: Build
        shell: powershell
        run: |
          C:\cygwin64\bin\bash.exe --noprofile --norc -eo pipefail -c "make"

      - name: Copy runtime DLLs from MinGW
        shell: powershell
        run: |
          $dllDir = "C:\mingw64\bin"
          $dlls = @(
            'libgcc_s_seh-1.dll',
            'libstdc++-6.dll',
            'libwinpthread-1.dll'
          )

          foreach ($dll in $dlls) {
            $srcPath = Join-Path $dllDir $dll
            if (Test-Path $srcPath) {
              Copy-Item $srcPath -Destination '.' -Force
              Write-Host "Copied $dll from $srcPath"
            } else {
              Write-Error "Required DLL '$dll' not found at $srcPath"
              exit 1
            }
          }

      - name: Verify build output
        shell: powershell
        run: |
          if (Test-Path "video-compare.exe") {
            $file = Get-Item "video-compare.exe"
            Write-Host "Build successful!"
            Write-Host "File: $($file.Name)"
            Write-Host "Size: $([math]::Round($file.Length / 1MB, 2)) MB"
            Write-Host "Date: $($file.LastWriteTime)"
          } else {
            Write-Error "Build failed: video-compare.exe not found"
            exit 1
          }

      - name: Strip executable
        shell: powershell
        run: |
          $stripPath = "C:\mingw64\bin\strip.exe"
          if (Test-Path $stripPath) {
            Write-Host "Stripping executable using $stripPath"
            & $stripPath video-compare.exe
            $file = Get-Item "video-compare.exe"
            Write-Host "Stripped executable. New size: $([math]::Round($file.Length / 1MB, 2)) MB"
          } else {
            Write-Error "strip tool not found at $stripPath"
            exit 1
          }

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: video-compare-windows
          path: |
            video-compare.exe
            *.dll
            README.md
          retention-days: 90

  release-windows:
    if: startsWith(github.ref, 'refs/tags/')
    needs: build-windows
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
      attestations: write
    env:
      ZIP_NAME: video-compare-${{ github.ref_name }}-win10-x86_64.zip

    steps:
      - name: Download Windows build artifacts
        uses: actions/download-artifact@v4
        with:
          name: video-compare-windows

      - name: Package Windows release
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y zip

          mkdir -p release
          cp -f video-compare.exe README.md release/
          # Copy all DLLs (if any) from the Windows artifact bundle.
          shopt -s nullglob
          dlls=( *.dll )
          if [ "${#dlls[@]}" -gt 0 ]; then
            cp -f *.dll release/
          fi

          rm -f "$ZIP_NAME"
          (cd release && zip -r "../$ZIP_NAME" .)

          echo "Created $ZIP_NAME"
          ls -lh "$ZIP_NAME"

      - name: Generate artifact attestation (Windows zip)
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: ${{ env.ZIP_NAME }}

      - name: Install Syft (SBOM generator)
        shell: bash
        run: |
          set -euo pipefail
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sudo sh -s -- -b /usr/local/bin
          syft version

      - name: Generate SBOM (SPDX JSON)
        shell: bash
        run: |
          set -euo pipefail
          syft dir:release -o spdx-json=sbom.spdx.json
          ls -lh sbom.spdx.json

      - name: Generate SBOM attestation (Windows zip)
        uses: actions/attest-sbom@v2
        with:
          subject-path: ${{ env.ZIP_NAME }}
          sbom-path: sbom.spdx.json

      - name: Create draft GitHub Release (if missing)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          tag="${GITHUB_REF_NAME}"
          if ! gh release view "$tag" >/dev/null 2>&1; then
            gh release create "$tag" --draft --title "$tag" --notes "Release $tag"
          else
            echo "Release $tag already exists"
          fi

      - name: Upload Windows zip to GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          tag="${GITHUB_REF_NAME}"
          gh release upload "$tag" "$ZIP_NAME" --clobber=false
          gh release upload "$tag" sbom.spdx.json --clobber=false

  build-linux:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libavformat-dev \
            libavcodec-dev \
            libavfilter-dev \
            libavutil-dev \
            libswscale-dev \
            libswresample-dev \
            libsdl2-dev \
            libsdl2-ttf-dev

      - name: Build
        run: make

      - name: Verify build output
        run: |
          if [ -f "video-compare" ]; then
            echo "Build successful!"
            ls -lh video-compare
            file video-compare
          else
            echo "Build failed: video-compare not found"
            exit 1
          fi

      - name: Strip executable
        run: |
          strip video-compare
          echo "Stripped executable. New size:"
          ls -lh video-compare

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: video-compare-linux
          path: |
            video-compare
            README.md
          retention-days: 90

  build-macos:
    runs-on: macos-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies via Homebrew
        run: |
          brew install ffmpeg sdl2 sdl2_ttf

      - name: Build
        run: make

      - name: Verify build output
        run: |
          if [ -f "video-compare" ]; then
            echo "Build successful!"
            ls -lh video-compare
            file video-compare
          else
            echo "Build failed: video-compare not found"
            exit 1
          fi

      - name: Strip executable
        run: |
          strip video-compare
          echo "Stripped executable. New size:"
          ls -lh video-compare

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: video-compare-macos
          path: |
            video-compare
            README.md
          retention-days: 90
